import{keccak256 as e,createWalletClient as t,custom as n,createPublicClient as r,http as a,encodeFunctionData as s,recoverTypedDataAddress as o,stringToHex as i,pad as c,decodeFunctionData as l}from"viem";const d=[{inputs:[{internalType:"address",name:"_trustedForwarder",type:"address"},{internalType:"address",name:"_feeReceiver",type:"address"},{internalType:"address",name:"_feeRuleProvider",type:"address"}],stateMutability:"nonpayable",type:"constructor"},{inputs:[{internalType:"address",name:"owner",type:"address"}],name:"OwnableInvalidOwner",type:"error"},{inputs:[{internalType:"address",name:"account",type:"address"}],name:"OwnableUnauthorizedAccount",type:"error"},{inputs:[{internalType:"address",name:"token",type:"address"}],name:"SafeERC20FailedOperation",type:"error"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"user",type:"address"},{indexed:!0,internalType:"bytes32",name:"merchantId",type:"bytes32"},{indexed:!0,internalType:"address",name:"token",type:"address"},{indexed:!1,internalType:"uint256",name:"originalAmount",type:"uint256"},{indexed:!1,internalType:"uint256",name:"discountedAmount",type:"uint256"},{indexed:!1,internalType:"uint256",name:"spendAmount",type:"uint256"},{indexed:!1,internalType:"uint256",name:"merchantAmount",type:"uint256"},{indexed:!1,internalType:"uint256",name:"pointsUsed",type:"uint256"},{indexed:!1,internalType:"uint256",name:"voucherUsed",type:"uint256"},{indexed:!1,internalType:"uint256",name:"pointsReward",type:"uint256"},{indexed:!1,internalType:"uint256",name:"voucherReward",type:"uint256"},{indexed:!1,internalType:"uint256",name:"feePaid",type:"uint256"},{indexed:!1,internalType:"address",name:"merchantRecipient",type:"address"},{indexed:!1,internalType:"address",name:"feeReceiver",type:"address"},{indexed:!1,internalType:"uint256",name:"seq",type:"uint256"}],name:"Consumed",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"user",type:"address"},{indexed:!0,internalType:"bytes32",name:"merchantId",type:"bytes32"},{indexed:!0,internalType:"address",name:"token",type:"address"},{indexed:!1,internalType:"uint256",name:"amount",type:"uint256"}],name:"Deposit",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"merchantId",type:"bytes32"},{indexed:!0,internalType:"address",name:"operator",type:"address"}],name:"MerchantOperatorSet",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"previousOwner",type:"address"},{indexed:!0,internalType:"address",name:"newOwner",type:"address"}],name:"OwnershipTransferred",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"to",type:"address"},{indexed:!1,internalType:"bytes32",name:"merchantId",type:"bytes32"},{indexed:!1,internalType:"uint256",name:"amount",type:"uint256"}],name:"PointsGranted",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"merchantId",type:"bytes32"},{indexed:!1,internalType:"uint256",name:"idx",type:"uint256"},{indexed:!1,internalType:"uint256",name:"minAmount",type:"uint256"},{indexed:!1,internalType:"uint256",name:"discountRate",type:"uint256"},{indexed:!1,internalType:"uint256",name:"voucherAmount",type:"uint256"},{indexed:!1,internalType:"uint256",name:"pointAmount",type:"uint256"},{indexed:!1,internalType:"uint256",name:"startTime",type:"uint256"},{indexed:!1,internalType:"uint256",name:"endTime",type:"uint256"},{indexed:!1,internalType:"uint256",name:"voucherExpirePeriod",type:"uint256"},{indexed:!1,internalType:"bool",name:"enabled",type:"bool"}],name:"PromoTierSet",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"token",type:"address"},{indexed:!1,internalType:"bool",name:"status",type:"bool"}],name:"TokenWhitelistChanged",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"user",type:"address"},{indexed:!0,internalType:"bytes32",name:"fromMerchantId",type:"bytes32"},{indexed:!0,internalType:"bytes32",name:"toMerchantId",type:"bytes32"},{indexed:!1,internalType:"address",name:"token",type:"address"},{indexed:!1,internalType:"uint256",name:"amount",type:"uint256"}],name:"TransferMerchantBalance",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"to",type:"address"},{indexed:!1,internalType:"uint256",name:"voucherId",type:"uint256"},{indexed:!1,internalType:"bytes32",name:"merchantId",type:"bytes32"},{indexed:!1,internalType:"address",name:"token",type:"address"},{indexed:!1,internalType:"uint256",name:"amount",type:"uint256"},{indexed:!1,internalType:"uint256",name:"expireAt",type:"uint256"}],name:"VoucherGranted",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"user",type:"address"},{indexed:!0,internalType:"bytes32",name:"merchantId",type:"bytes32"},{indexed:!0,internalType:"address",name:"token",type:"address"},{indexed:!1,internalType:"uint256",name:"amount",type:"uint256"}],name:"Withdraw",type:"event"},{inputs:[{internalType:"bytes32",name:"merchantId",type:"bytes32"},{internalType:"address",name:"token",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"},{internalType:"uint256",name:"voucherId",type:"uint256"},{internalType:"uint256",name:"pointToUse",type:"uint256"},{internalType:"uint256",name:"seq",type:"uint256"},{internalType:"uint256",name:"idx",type:"uint256"},{internalType:"address",name:"recipient",type:"address"}],name:"consume",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes32",name:"merchantId",type:"bytes32"},{internalType:"address",name:"token",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"}],name:"deposit",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"feeReceiver",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[],name:"feeRuleProvider",outputs:[{internalType:"contract IFeeRuleProvider",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"merchantId",type:"bytes32"},{internalType:"address",name:"token",type:"address"}],name:"getMyBalance",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"merchantId",type:"bytes32"}],name:"getMyPoints",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"getMyVouchers",outputs:[{internalType:"uint256[]",name:"",type:"uint256[]"},{internalType:"bytes32[]",name:"",type:"bytes32[]"},{internalType:"address[]",name:"",type:"address[]"},{internalType:"uint256[]",name:"",type:"uint256[]"},{internalType:"bool[]",name:"",type:"bool[]"},{internalType:"uint256[]",name:"",type:"uint256[]"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"merchantId",type:"bytes32"},{internalType:"uint256",name:"idx",type:"uint256"}],name:"getPromoTier",outputs:[{internalType:"uint256",name:"_minAmount",type:"uint256"},{internalType:"uint256",name:"discountRate",type:"uint256"},{internalType:"uint256",name:"voucherAmount",type:"uint256"},{internalType:"uint256",name:"pointAmount",type:"uint256"},{internalType:"uint256",name:"startTime",type:"uint256"},{internalType:"uint256",name:"endTime",type:"uint256"},{internalType:"uint256",name:"voucherExpirePeriod",type:"uint256"},{internalType:"bool",name:"enabled",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"user",type:"address"},{internalType:"bytes32",name:"merchantId",type:"bytes32"},{internalType:"address",name:"token",type:"address"}],name:"getUserBalance",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"user",type:"address"},{internalType:"bytes32",name:"merchantId",type:"bytes32"}],name:"getUserPoints",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"uint256",name:"vid",type:"uint256"}],name:"getVoucher",outputs:[{internalType:"bytes32",name:"merchantId",type:"bytes32"},{internalType:"address",name:"token",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"},{internalType:"bool",name:"used",type:"bool"},{internalType:"uint256",name:"expireAt",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"forwarder",type:"address"}],name:"isTrustedForwarder",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"",type:"bytes32"}],name:"merchantOperator",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[],name:"nextTierIndex",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"nextVoucherId",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"owner",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"merchantId",type:"bytes32"}],name:"removeMerchantOperator",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"renounceOwnership",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes32",name:"merchantId",type:"bytes32"},{internalType:"address",name:"operator",type:"address"}],name:"setMerchantOperator",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes32",name:"merchantId",type:"bytes32"},{internalType:"uint256",name:"idx",type:"uint256"},{internalType:"uint256",name:"minAmount",type:"uint256"},{internalType:"uint256",name:"discountRate",type:"uint256"},{internalType:"uint256",name:"voucherAmount",type:"uint256"},{internalType:"uint256",name:"pointAmount",type:"uint256"},{internalType:"uint256",name:"startTime",type:"uint256"},{internalType:"uint256",name:"endTime",type:"uint256"},{internalType:"uint256",name:"voucherExpirePeriod",type:"uint256"},{internalType:"bool",name:"enabled",type:"bool"}],name:"setPromoTier",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"token",type:"address"},{internalType:"bool",name:"status",type:"bool"}],name:"setTokenWhitelist",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"forwarder",type:"address"}],name:"setTrustedForwarder",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"",type:"address"}],name:"tokenWhitelist",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"fromMerchantId",type:"bytes32"},{internalType:"bytes32",name:"toMerchantId",type:"bytes32"},{internalType:"address",name:"token",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"}],name:"transferMerchantBalance",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"newOwner",type:"address"}],name:"transferOwnership",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"trustedForwarder",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"uint256",name:"",type:"uint256"}],name:"usedSeq",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"",type:"address"},{internalType:"bytes32",name:"",type:"bytes32"},{internalType:"address",name:"",type:"address"}],name:"userMerchantBalances",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"",type:"address"},{internalType:"bytes32",name:"",type:"bytes32"}],name:"userMerchantPoints",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"",type:"address"},{internalType:"uint256",name:"",type:"uint256"}],name:"userVouchers",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"uint256",name:"",type:"uint256"}],name:"vouchers",outputs:[{internalType:"bytes32",name:"merchantId",type:"bytes32"},{internalType:"address",name:"token",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"},{internalType:"bool",name:"used",type:"bool"},{internalType:"uint256",name:"expireAt",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"merchantId",type:"bytes32"},{internalType:"address",name:"token",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"}],name:"withdraw",outputs:[],stateMutability:"nonpayable",type:"function"}],u=[{inputs:[{internalType:"string",name:"_name",type:"string"},{internalType:"address",name:"_feeAddress",type:"address"},{internalType:"uint256",name:"_feePpm",type:"uint256"},{internalType:"address",name:"_initTrustedForwarder",type:"address"},{internalType:"address[]",name:"initialTokens",type:"address[]"},{internalType:"uint256[]",name:"initialMinUnits",type:"uint256[]"}],stateMutability:"nonpayable",type:"constructor"},{inputs:[{internalType:"address",name:"owner",type:"address"}],name:"OwnableInvalidOwner",type:"error"},{inputs:[{internalType:"address",name:"account",type:"address"}],name:"OwnableUnauthorizedAccount",type:"error"},{inputs:[{internalType:"address",name:"token",type:"address"}],name:"SafeERC20FailedOperation",type:"error"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"newFeeAddress",type:"address"}],name:"FeeAddressUpdated",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"to",type:"address"},{indexed:!1,internalType:"uint256",name:"newFeePpm",type:"uint256"}],name:"FeePpmForToUpdated",type:"event"},{anonymous:!1,inputs:[{indexed:!1,internalType:"uint256",name:"newFeePpm",type:"uint256"}],name:"FeePpmUpdated",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"token",type:"address"},{indexed:!1,internalType:"uint256",name:"minUnit",type:"uint256"}],name:"MinUnitUpdated",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"previousOwner",type:"address"},{indexed:!0,internalType:"address",name:"newOwner",type:"address"}],name:"OwnershipTransferred",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"payer",type:"address"},{indexed:!0,internalType:"address",name:"token",type:"address"},{indexed:!0,internalType:"address",name:"to",type:"address"},{indexed:!1,internalType:"uint256",name:"amount",type:"uint256"},{indexed:!1,internalType:"uint256",name:"fee",type:"uint256"},{indexed:!1,internalType:"uint256",name:"toAmount",type:"uint256"},{indexed:!1,internalType:"uint256",name:"seq",type:"uint256"}],name:"Paid",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"token",type:"address"},{indexed:!1,internalType:"bool",name:"isWhitelisted",type:"bool"}],name:"TokenWhitelistUpdated",type:"event"},{anonymous:!1,inputs:[{indexed:!1,internalType:"address",name:"newForwarder",type:"address"}],name:"TrustedForwarderUpdated",type:"event"},{inputs:[],name:"MAX_AMOUNT",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"feeAddress",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[],name:"feePpm",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"",type:"address"}],name:"feePpmPerTo",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"token",type:"address"}],name:"isTokenWhitelisted",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"forwarder",type:"address"}],name:"isTrustedForwarder",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"",type:"address"}],name:"minUnitPerToken",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"name",outputs:[{internalType:"string",name:"",type:"string"}],stateMutability:"view",type:"function"},{inputs:[],name:"owner",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"token",type:"address"},{internalType:"address",name:"to",type:"address"},{internalType:"uint256",name:"amount",type:"uint256"},{internalType:"uint256",name:"seq",type:"uint256"}],name:"pay",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"renounceOwnership",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"uint256",name:"_feePpm",type:"uint256"}],name:"setFee",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"_feeAddress",type:"address"}],name:"setFeeAddress",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"to",type:"address"},{internalType:"uint256",name:"newFeePpm",type:"uint256"}],name:"setFeePpmForTo",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"token",type:"address"},{internalType:"uint256",name:"minUnit",type:"uint256"}],name:"setMinUnit",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"token",type:"address"},{internalType:"bool",name:"allowed",type:"bool"}],name:"setTokenWhitelist",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"forwarder",type:"address"}],name:"setTrustedForwarder",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"",type:"address"}],name:"tokenWhitelist",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"newOwner",type:"address"}],name:"transferOwnership",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"trustedForwarder",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"uint256",name:"",type:"uint256"}],name:"usedSeq",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"}],p=[{inputs:[],stateMutability:"nonpayable",type:"constructor"},{inputs:[{internalType:"uint48",name:"deadline",type:"uint48"}],name:"ERC2771ForwarderExpiredRequest",type:"error"},{inputs:[{internalType:"address",name:"signer",type:"address"},{internalType:"address",name:"from",type:"address"}],name:"ERC2771ForwarderInvalidSigner",type:"error"},{inputs:[{internalType:"uint256",name:"requestedValue",type:"uint256"},{internalType:"uint256",name:"msgValue",type:"uint256"}],name:"ERC2771ForwarderMismatchedValue",type:"error"},{inputs:[{internalType:"address",name:"target",type:"address"},{internalType:"address",name:"forwarder",type:"address"}],name:"ERC2771UntrustfulTarget",type:"error"},{inputs:[],name:"FailedCall",type:"error"},{inputs:[{internalType:"uint256",name:"balance",type:"uint256"},{internalType:"uint256",name:"needed",type:"uint256"}],name:"InsufficientBalance",type:"error"},{inputs:[{internalType:"address",name:"account",type:"address"},{internalType:"uint256",name:"currentNonce",type:"uint256"}],name:"InvalidAccountNonce",type:"error"},{inputs:[],name:"InvalidShortString",type:"error"},{inputs:[{internalType:"string",name:"str",type:"string"}],name:"StringTooLong",type:"error"},{anonymous:!1,inputs:[],name:"EIP712DomainChanged",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"signer",type:"address"},{indexed:!1,internalType:"uint256",name:"nonce",type:"uint256"},{indexed:!1,internalType:"bool",name:"success",type:"bool"}],name:"ExecutedForwardRequest",type:"event"},{inputs:[],name:"eip712Domain",outputs:[{internalType:"bytes1",name:"fields",type:"bytes1"},{internalType:"string",name:"name",type:"string"},{internalType:"string",name:"version",type:"string"},{internalType:"uint256",name:"chainId",type:"uint256"},{internalType:"address",name:"verifyingContract",type:"address"},{internalType:"bytes32",name:"salt",type:"bytes32"},{internalType:"uint256[]",name:"extensions",type:"uint256[]"}],stateMutability:"view",type:"function"},{inputs:[{components:[{internalType:"address",name:"from",type:"address"},{internalType:"address",name:"to",type:"address"},{internalType:"uint256",name:"value",type:"uint256"},{internalType:"uint256",name:"gas",type:"uint256"},{internalType:"uint48",name:"deadline",type:"uint48"},{internalType:"bytes",name:"data",type:"bytes"},{internalType:"bytes",name:"signature",type:"bytes"}],internalType:"struct ERC2771Forwarder.ForwardRequestData",name:"request",type:"tuple"}],name:"execute",outputs:[],stateMutability:"payable",type:"function"},{inputs:[{components:[{internalType:"address",name:"from",type:"address"},{internalType:"address",name:"to",type:"address"},{internalType:"uint256",name:"value",type:"uint256"},{internalType:"uint256",name:"gas",type:"uint256"},{internalType:"uint48",name:"deadline",type:"uint48"},{internalType:"bytes",name:"data",type:"bytes"},{internalType:"bytes",name:"signature",type:"bytes"}],internalType:"struct ERC2771Forwarder.ForwardRequestData[]",name:"requests",type:"tuple[]"},{internalType:"address payable",name:"refundReceiver",type:"address"}],name:"executeBatch",outputs:[],stateMutability:"payable",type:"function"},{inputs:[{internalType:"address",name:"owner",type:"address"}],name:"nonces",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{components:[{internalType:"address",name:"from",type:"address"},{internalType:"address",name:"to",type:"address"},{internalType:"uint256",name:"value",type:"uint256"},{internalType:"uint256",name:"gas",type:"uint256"},{internalType:"uint48",name:"deadline",type:"uint48"},{internalType:"bytes",name:"data",type:"bytes"},{internalType:"bytes",name:"signature",type:"bytes"}],internalType:"struct ERC2771Forwarder.ForwardRequestData",name:"request",type:"tuple"}],name:"verify",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"}];e("EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"),e("ForwardRequest(address from,address to,uint256 value,uint256 gas,uint256 nonce,uint48 deadline,bytes data)");const y=[{name:"name",type:"string"},{name:"version",type:"string"},{name:"chainId",type:"uint256"},{name:"verifyingContract",type:"address"}],h={ForwardRequest:[{name:"from",type:"address"},{name:"to",type:"address"},{name:"value",type:"uint256"},{name:"gas",type:"uint256"},{name:"nonce",type:"uint256"},{name:"deadline",type:"uint48"},{name:"data",type:"bytes"}]},m=[{inputs:[{type:"address",name:"to"},{type:"uint256",name:"amount"}],name:"transfer",outputs:[{type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[{type:"address",name:"owner"},{type:"address",name:"spender"}],name:"allowance",outputs:[{type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{type:"address",name:"spender"},{type:"uint256",name:"amount"}],name:"approve",outputs:[{type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[{type:"address",name:"account"}],name:"balanceOf",outputs:[{type:"uint256"}],stateMutability:"view",type:"function"}],g="undefined"!=typeof window;class w{constructor(e){this.config=e}async initializeClients(e=15e3){if(console.log("开始初始化钱包客户端..."),!g)throw new Error("钱包只能在浏览器环境中使用");const a=g&&(window.ethereum||window.walletLinkExtension||window.walletConnect||window.coinbaseWalletExtension)||null;if(!a)throw console.error("未检测到可用的钱包"),new Error("未检测到可用的钱包。请安装MetaMask、Coinbase Wallet或其他以太坊钱包。");console.log("检测到钱包提供者，创建钱包客户端...");try{const s=(e,t,n)=>Promise.race([e,new Promise(((e,r)=>setTimeout((()=>r(new Error(n))),t)))]),o=await s(a.request({method:"eth_chainId"}),e,"获取链ID超时，请检查钱包连接状态");return this.chainId=parseInt(o,16),console.log("从钱包获取到链 ID:",this.chainId),this.wallet=t({transport:n(a)}),console.log("钱包客户端创建完成"),this.publicClient=r({transport:n(a)}),console.log("公共客户端创建完成"),!0}catch(e){throw console.error("初始化客户端失败:",e),console.error("错误详情:",{message:e.message,code:e.code,data:e.data}),new Error(`初始化客户端失败: ${e.message}`)}}async connectWallet(e=15e3){this.wallet&&this.publicClient||await this.initializeClients(e);try{console.log("请求连接钱包...");const t=(e,t,n)=>Promise.race([e,new Promise(((e,r)=>setTimeout((()=>r(new Error(n))),t)))]),[n]=await t(this.wallet.requestAddresses(),e,"请求钱包地址超时，用户可能未响应钱包连接请求");return console.log("获取到钱包地址:",n),this.account={address:n,type:"json-rpc"},n}catch(e){throw console.error("连接钱包失败:",e),new Error(`连接钱包失败: ${e.message}`)}}isConnected(){return!!this.account}getConnectedAddress(){return this.account?.address}getChainId(){return this.chainId}getWallet(){return this.wallet}getPublicClient(){return this.publicClient}getAccount(){return this.account}async ensureConnected(e=15e3){return this.isConnected()||await this.connectWallet(e),this.isConnected()}async ensureInitialized(e=15e3){return this.publicClient&&this.wallet||await this.initializeClients(e),!!this.publicClient&&!!this.wallet}}class b extends w{constructor(e={}){console.log("[BlockchainService] 构造收到的config:",e);const t={rpcUrl:e.rpcUrl,paymentContractAddress:e.paymentContractAddress||"",vaultContractAddress:e.vaultContractAddress||"",forwarderAddress:e.forwarderAddress||""};console.log("[BlockchainService] delegateConfig:",t),super(t),this.customRpcClient=null}getWalletClient(){return this.wallet}getAccount(){return this.account}async ensureWalletConnected(e=15e3){await this.ensureConnected(e)}async ensureTokenAllowance(e,t,n){await this.ensureWalletConnected();const r=await this.readContract(e,m,"allowance",[this.account.address,t]);return console.log(`当前allowance: ${r} 需要: ${n}`),r>=n?(console.log("授权额度充足"),!0):(console.log("授权额度不足，发起approve..."),await this.writeContract(e,m,"approve",[t,n]),console.log("approve成功"),!0)}async getNonce(e,t){try{return await this.readContract(this.getForwarderAddress(),p,"nonces",[e],t)}catch(e){throw e}}async sendTransaction(e,t,n){await this.ensureWalletConnected(),console.log("发送交易..."),console.log("- 发送方:",this.account.address),console.log("- 接收方:",e),console.log("- 金额:",t.toString());const r={account:this.account,chain:this.chainId?{id:this.chainId}:void 0,to:e,value:t,data:n};try{const e=await this.wallet.sendTransaction(r);console.log("交易已发送，等待确认，哈希:",e);if("success"!==(await this.publicClient.waitForTransactionReceipt({hash:e})).status)throw new Error("交易执行失败");return console.log("交易已确认"),e}catch(e){throw console.error("发送交易失败:",e),new Error(`发送交易失败: ${e.message}`)}}async writeContract(e,t,n,r,a=0n){await this.ensureWalletConnected(),console.log("调用合约写方法..."),console.log("- 合约地址:",e),console.log("- 函数名:",n),console.log("- 参数:",r);try{const s=await this.wallet.writeContract({account:this.account,chain:this.chainId?{id:this.chainId}:void 0,address:e,abi:t,functionName:n,args:r,value:a});console.log("合约调用已发送，等待确认，哈希:",s);if("success"!==(await this.publicClient.waitForTransactionReceipt({hash:s})).status)throw new Error("合约调用执行失败");return console.log("合约调用已确认"),s}catch(e){throw console.error("调用合约写方法失败:",e),new Error(`调用合约写方法失败: ${e.message}`)}}async readContract(e,t,n,r=[],a){const s=a?.timeout??1e4;console.log("调用合约读方法..."),console.log("- 合约地址:",e),console.log("- 函数名:",n),console.log("- 参数:",r);try{const a=await Promise.race([this.getCustomRpcClient().readContract({address:e,abi:t,functionName:n,args:r}),new Promise(((e,t)=>setTimeout((()=>t(new Error("TimeoutError: readContract timeout"))),s)))]);return console.log("合约读取结果:",a),a}catch(e){throw console.error("调用合约读方法失败:",e),new Error(`调用合约读方法失败: ${e.message}`)}}getPaymentContractAddress(){const e=this.config?.paymentContractAddress||"";return console.log("[BlockchainService] getPaymentContractAddress 返回:",e),e}getVaultContractAddress(){const e=this.config?.vaultContractAddress||"";return console.log("[BlockchainService] getVaultContractAddress 返回:",e),e}getForwarderAddress(){const e=this.config?.forwarderAddress||"";return console.log("[BlockchainService] getForwarderAddress 返回:",e),e}getCustomRpcClient(){if(this.customRpcClient)return this.customRpcClient;const e=this.config.rpcUrl;if(e)return console.log("使用配置的 RPC URL:",e),this.customRpcClient=r({transport:a(e)}),this.customRpcClient;if(this.publicClient)return console.log("使用钱包提供的 RPC 连接"),this.customRpcClient=this.publicClient,this.customRpcClient;throw console.error("未提供RPC URL且未连接钱包"),new Error("未提供RPC URL且未连接钱包，请配置RPC URL或连接MetaMask")}getEstimateClient(){return this.publicClient?this.publicClient:this.getCustomRpcClient()}}class T{constructor(e){this.blockchainService=e}async approveToken(e,t,n){await this.blockchainService.ensureWalletConnected();const r=this.blockchainService.getWalletClient(),a=this.blockchainService.getAccount(),s=this.blockchainService.getChainId();if(!r||!a||void 0===s)throw new Error("钱包未连接或初始化失败");console.log(`开始授权代币 ${e} 给 ${t}，金额: ${n.toString()}`);const o=await r.writeContract({account:a,chain:{id:s},address:e,abi:m,functionName:"approve",args:[t,n]});return console.log("授权交易已发送，哈希:",o),o}async checkAllowance(e,t,n){await this.blockchainService.ensureWalletConnected();const r=this.blockchainService.getPublicClient();if(!r)throw new Error("公共客户端未初始化");const a=await r.readContract({address:e,abi:m,functionName:"allowance",args:[t,n]});return console.log(`当前授权额度: ${a.toString()}`),a}async ensureTokenAllowance(e,t,n){const r=this.blockchainService.getConnectedAddress();if(!r)throw new Error("钱包未连接");const a=await this.checkAllowance(e,r,t);if(console.log(`检查授权额度: 当前 ${a.toString()}, 需要 ${n.toString()}`),a>=n)return console.log("授权额度充足"),!0;console.log("授权额度不足，发起授权交易...");const s=await this.approveToken(e,t,n),o=this.blockchainService.getPublicClient();if(o){console.log("等待授权交易确认...");if("success"!==(await o.waitForTransactionReceipt({hash:s})).status)throw new Error("授权交易失败");console.log("授权交易确认成功")}return!0}async getTokenBalance(e,t){await this.blockchainService.ensureWalletConnected();const n=this.blockchainService.getPublicClient();if(!n)throw new Error("公共客户端未初始化");const r=t||this.blockchainService.getConnectedAddress();if(!r)throw new Error("未指定查询地址且钱包未连接");const a=await n.readContract({address:e,abi:m,functionName:"balanceOf",args:[r]});return console.log(`代币 ${e} 余额: ${a.toString()}`),a}}class v{constructor(e){this.blockchainService=e,this.tokenOperations=new T(e)}async pay(e,t,n,r=BigInt(Math.floor(Date.now()/1e3))){await this.blockchainService.ensureWalletConnected();const a=this.blockchainService.getWalletClient(),s=this.blockchainService.getAccount(),o=this.blockchainService.getChainId();if(!a||!s||void 0===o)throw new Error("钱包未连接或初始化失败");console.log("开始直接支付:"),console.log("- 接收方:",e),console.log("- 金额:",t.toString()),console.log("- 代币地址:",n||"ETH"),console.log("- 序列号:",r.toString()),console.log("- paymentContractAddress:",this.blockchainService.getPaymentContractAddress()),n&&await this.tokenOperations.ensureTokenAllowance(n,this.blockchainService.getPaymentContractAddress(),t);const i=await a.writeContract({account:s,chain:{id:o},address:this.blockchainService.getPaymentContractAddress(),abi:u,functionName:"pay",args:[n||"0x0000000000000000000000000000000000000000",e,t,r],value:n?0n:t});return console.log("支付交易已发送，哈希:",i),i}encodePayCallData(e,t,n,r=0n){const a=s({abi:u,functionName:"pay",args:[e,t,n,r]});return console.log("编码支付调用参数:"),console.log("- token:",e),console.log("- to:",t),console.log("- amount:",n.toString()),console.log("- seq:",r.toString()),a}}const f="undefined"!=typeof window;class C{constructor(e){this.blockchainService=e}async verifyTypedDataSignature({chainId:e,message:t,signature:n,expectedSigner:r}){const a={name:"MetaTxForwarder",version:"1",chainId:e,verifyingContract:this.blockchainService.getForwarderAddress()},s=await o({domain:a,types:h,primaryType:"ForwardRequest",message:t,signature:n});return{valid:s.toLowerCase()===r.toLowerCase(),signer:s}}async signTypedData(e,t,n){console.log("开始签名过程，参数:"),console.log("- 账户地址:",e.from),console.log("- 链 ID:",t),console.log("- Nonce:",n.toString());const r={name:"MetaTxForwarder",version:"1",chainId:t,verifyingContract:this.blockchainService.getForwarderAddress()},a={from:e.from,to:e.to,value:e.value.toString(),gas:e.gas.toString(),nonce:e.nonce.toString(),deadline:e.deadline.toString(),data:e.data};try{const n=this.blockchainService.getWalletClient(),s=this.blockchainService.getAccount();if(!n||!s)throw new Error("钱包未连接或初始化失败");if(n.signTypedData){console.log("使用 viem 钱包客户端签名...");try{const e=await n.signTypedData({account:s,domain:r,types:{...h},primaryType:"ForwardRequest",message:a});return console.log("viem 签名成功:",e),e}catch(e){console.warn("viem 签名失败，回退到原生方法:",e.message)}}if(!f||!window.ethereum)throw new Error("浏览器环境不可用或未安装钱包");console.log("使用浏览器原生签名方法...");const o={domain:{...r,chainId:r.chainId.toString()},message:a,primaryType:"ForwardRequest",types:{EIP712Domain:y,...h}};let i;try{i=await window.ethereum.request({method:"eth_signTypedData_v4",params:[e.from,JSON.stringify(o)]})}catch(t){console.warn("eth_signTypedData_v4 失败，尝试 eth_signTypedData_v3"),i=await window.ethereum.request({method:"eth_signTypedData_v3",params:[e.from,JSON.stringify(o)]})}const{valid:c,signer:l}=await this.verifyTypedDataSignature({chainId:t,message:a,signature:i,expectedSigner:e.from});if(console.log("签名验证：",c,l),!c)throw new Error("签名验证失败");return console.log("签名成功:",i),i}catch(e){throw console.error("签名过程中出错:",e),new Error(`签名失败: ${e.message}`)}}}class k{constructor(e){this.blockchainService=e,this.tokenOperations=new T(e),this.directPayment=new v(e),this.signingService=new C(e)}async preparePayment(e,t,n,r,a=3600){await this.blockchainService.ensureWalletConnected();const s=this.blockchainService.getAccount(),o=this.blockchainService.getChainId();if(!s||void 0===o)throw new Error("钱包未连接或初始化失败");console.log("准备代付gas支付请求:"),console.log("- 接收方:",e),console.log("- 金额:",t.toString()),console.log("- 序列号:",n.toString()),console.log("- 代币地址:",r||"ETH"),console.log("- 过期时间(秒):",a),r&&await this.tokenOperations.ensureTokenAllowance(r,this.blockchainService.getPaymentContractAddress(),t);const i=this.directPayment.encodePayCallData(r||"0x0000000000000000000000000000000000000000",e,t,n),c=Math.floor(Date.now()/1e3)+a,l=await this.blockchainService.getNonce(s.address),d=await this.blockchainService.getEstimateClient().estimateContractGas({address:this.blockchainService.getPaymentContractAddress(),abi:u,functionName:"pay",args:[r||"0x0000000000000000000000000000000000000000",e,t,n],account:s.address}),p={from:s.address,to:this.blockchainService.getPaymentContractAddress(),value:r?"0":t.toString(),gas:d.toString(),nonce:l.toString(),deadline:c.toString(),data:i};console.log("构建的请求数据:",p);try{const e=await this.signingService.signTypedData(p,o,l);p.signature=e,console.log("签名成功")}catch(e){console.error("签名失败:",e),console.warn("返回未签名的请求数据")}return p}}class S{constructor(e){this.blockchainService=e,this.tokenOperations=new T(e),this.signingService=new C(e)}stringToBytes32(e){if(e.startsWith("0x")&&66===e.length)return e;const t=i(e);return c(t,{size:32})}async validateTokenWhitelist(e){if(!this.blockchainService.getPublicClient())throw new Error("公共客户端未初始化");if(!await this.blockchainService.readContract(this.blockchainService.getVaultContractAddress(),d,"tokenWhitelist",[e]))throw new Error("Token not whitelisted")}validateAmount(e){if(e<=0n)throw new Error("Amount must be greater than 0")}async validateMerchantRecipient(e){if(!this.blockchainService.getPublicClient())throw new Error("公共客户端未初始化");const t=this.stringToBytes32(e);if("0x0000000000000000000000000000000000000000"===await this.blockchainService.readContract(this.blockchainService.getVaultContractAddress(),d,"merchantRecipients",[t]))throw new Error("Merchant recipient not set")}async validateSeq(e){if(!this.blockchainService.getPublicClient())throw new Error("公共客户端未初始化");if(await this.blockchainService.readContract(this.blockchainService.getVaultContractAddress(),d,"usedSeq",[e]))throw new Error("Seq already used")}async deposit(e,t,n){await this.blockchainService.ensureWalletConnected();const r=this.blockchainService.getWalletClient(),a=this.blockchainService.getAccount(),s=this.blockchainService.getChainId();if(!r||!a||void 0===s)throw new Error("钱包未连接或初始化失败");console.log("开始存款到金库:"),console.log("- 商户ID:",e),console.log("- 代币地址:",t),console.log("- 存款金额:",n.toString()),this.validateAmount(n),await this.validateTokenWhitelist(t);if(await this.tokenOperations.getTokenBalance(t,a.address)<n)throw new Error("Insufficient wallet balance");await this.tokenOperations.ensureTokenAllowance(t,this.blockchainService.getVaultContractAddress(),n);const o=this.stringToBytes32(e),i=await r.writeContract({account:a,chain:{id:s},address:this.blockchainService.getVaultContractAddress(),abi:d,functionName:"deposit",args:[o,t,n]});return console.log("存款交易已发送，哈希:",i),i}async withdraw(e,t,n){await this.blockchainService.ensureWalletConnected();const r=this.blockchainService.getWalletClient(),a=this.blockchainService.getAccount(),s=this.blockchainService.getChainId();if(!r||!a||void 0===s)throw new Error("钱包未连接或初始化失败");console.log("开始从金库提现:"),console.log("- 商户ID:",e),console.log("- 代币地址:",t),console.log("- 提现金额:",n.toString()),this.validateAmount(n);if(await this.getUserBalance(a.address,e,t)<n)throw new Error("Insufficient vault balance");const o=this.stringToBytes32(e),i=await r.writeContract({account:a,chain:{id:s},address:this.blockchainService.getVaultContractAddress(),abi:d,functionName:"withdraw",args:[o,t,n]});return console.log("提现交易已发送，哈希:",i),i}async consumeDirect(e,t,n,r=0n,a=0n,s=BigInt(Math.floor(Date.now()/1e3)),o,i,c){await this.blockchainService.ensureWalletConnected();const l=this.blockchainService.getWalletClient(),u=this.blockchainService.getAccount(),p=this.blockchainService.getChainId();if(!l||!u||void 0===p)throw new Error("钱包未连接或初始化失败");await this.validateConsumeParams({merchantId:e,token:t,amount:n,voucherId:r,pointToUse:a,seq:s,idx:o,recipient:i,userAddress:c||u.address});const y=this.stringToBytes32(e);return await l.writeContract({account:u,chain:{id:p},address:this.blockchainService.getVaultContractAddress(),abi:d,functionName:"consume",args:[y,t,n,r,a,s,o,i]})}async validateVoucher(e,t,n,r){if(!this.blockchainService.getPublicClient())throw new Error("公共客户端未初始化");if(!(await this.getMyVouchers()).ids.includes(e))throw new Error("Voucher not owned");const a=await this.getVoucher(e);if(a.used)throw new Error("Voucher already used");const s=Math.floor(Date.now()/1e3);if(a.expireAt<=s)throw new Error("Voucher expired");const o=this.stringToBytes32(t);if(a.merchantId!==o)throw new Error("Voucher merchant mismatch");if(a.token.toLowerCase()!==n.toLowerCase())throw new Error("Voucher token mismatch")}async transferMerchantBalance(e,t,n,r){await this.blockchainService.ensureWalletConnected();const a=this.blockchainService.getWalletClient(),s=this.blockchainService.getAccount(),o=this.blockchainService.getChainId();if(!a||!s||void 0===o)throw new Error("钱包未连接或初始化失败");if(console.log("开始余额跨商户转移:"),console.log("- 源商户ID:",e),console.log("- 目标商户ID:",t),console.log("- 代币地址:",n),console.log("- 转移金额:",r.toString()),e===t)throw new Error("Cannot transfer to same merchant");await this.validateTokenWhitelist(n),this.validateAmount(r);if(await this.getUserBalance(s.address,e,n)<r)throw new Error("Insufficient vault balance");const i=this.stringToBytes32(e),c=this.stringToBytes32(t),l=await a.writeContract({account:s,chain:{id:o},address:this.blockchainService.getVaultContractAddress(),abi:d,functionName:"transferMerchantBalance",args:[i,c,n,r]});return console.log("转移交易已发送，哈希:",l),l}async prepareRelayedConsume(e,t,n,r=0n,a=0n,o=BigInt(Math.floor(Date.now()/1e3)),i,c,l,u){await this.blockchainService.ensureWalletConnected();const p=this.blockchainService.getAccount(),y=this.blockchainService.getChainId();if(!p||void 0===y)throw new Error("钱包未连接或初始化失败");await this.validateConsumeParams({merchantId:e,token:t,amount:n,voucherId:r,pointToUse:a,seq:o,idx:i,recipient:c,userAddress:u||p.address});const h=this.stringToBytes32(e),m=s({abi:d,functionName:"consume",args:[h,t,n,r,a,o,i,c]}),g=Math.floor(Date.now()/1e3)+Number(l),w=await this.blockchainService.getNonce(u||p.address),b=await this.blockchainService.getEstimateClient().estimateContractGas({address:this.blockchainService.getVaultContractAddress(),abi:d,functionName:"consume",args:[h,t,n,r,a,o,i,c],account:u||p.address}),T={from:u||p.address,to:this.blockchainService.getVaultContractAddress(),value:"0",gas:b.toString(),nonce:w.toString(),deadline:g.toString(),data:m};try{const e=await this.signingService.signTypedData(T,y,w);T.signature=e}catch(e){}return T}async prepareRelayedDeposit(e,t,n,r){await this.blockchainService.ensureWalletConnected();const a=this.blockchainService.getAccount(),o=this.blockchainService.getChainId();if(!a||void 0===o)throw new Error("钱包未连接或初始化失败");console.log("准备代付gas存款请求:"),console.log("- 商户ID:",e),console.log("- 代币地址:",t),console.log("- 存款金额:",n.toString()),console.log("- 过期时间(秒):",r.toString()),this.validateAmount(n),await this.validateTokenWhitelist(t);if(await this.tokenOperations.getTokenBalance(t,a.address)<n)throw new Error("Insufficient wallet balance");await this.tokenOperations.ensureTokenAllowance(t,this.blockchainService.getVaultContractAddress(),n);const i=this.stringToBytes32(e),c=s({abi:d,functionName:"deposit",args:[i,t,n]}),l=Math.floor(Date.now()/1e3)+Number(r),u=await this.blockchainService.getNonce(a.address),p=await this.blockchainService.getEstimateClient().estimateContractGas({address:this.blockchainService.getVaultContractAddress(),abi:d,functionName:"deposit",args:[i,t,n],account:a.address}),y={from:a.address,to:this.blockchainService.getVaultContractAddress(),value:"0",gas:p.toString(),nonce:u.toString(),deadline:l.toString(),data:c};console.log("构建的请求数据:",y);try{const e=await this.signingService.signTypedData(y,o,u);y.signature=e,console.log("签名成功")}catch(e){console.error("签名失败:",e),console.warn("返回未签名的请求数据")}return y}async prepareRelayedWithdraw(e,t,n,r){await this.blockchainService.ensureWalletConnected();const a=this.blockchainService.getAccount(),o=this.blockchainService.getChainId();if(!a||void 0===o)throw new Error("钱包未连接或初始化失败");console.log("准备代付gas提款请求:"),console.log("- 商户ID:",e),console.log("- 代币地址:",t),console.log("- 提款金额:",n.toString()),console.log("- 过期时间(秒):",r.toString()),this.validateAmount(n);if(await this.getUserBalance(a.address,e,t)<n)throw new Error("Insufficient vault balance");const i=this.stringToBytes32(e),c=s({abi:d,functionName:"withdraw",args:[i,t,n]}),l=Math.floor(Date.now()/1e3)+Number(r),u=await this.blockchainService.getNonce(a.address),p=await this.blockchainService.getEstimateClient().estimateContractGas({address:this.blockchainService.getVaultContractAddress(),abi:d,functionName:"withdraw",args:[i,t,n],account:a.address}),y={from:a.address,to:this.blockchainService.getVaultContractAddress(),value:"0",gas:p.toString(),nonce:u.toString(),deadline:l.toString(),data:c};console.log("构建的请求数据:",y);try{const e=await this.signingService.signTypedData(y,o,u);y.signature=e,console.log("签名成功")}catch(e){console.error("签名失败:",e),console.warn("返回未签名的请求数据")}return y}async getUserBalance(e,t,n){await this.blockchainService.ensureWalletConnected();if(!this.blockchainService.getPublicClient())throw new Error("公共客户端未初始化");const r=this.stringToBytes32(t);console.log("查询用户金库余额:"),console.log("- 用户地址:",e),console.log("- 商户ID:",t),console.log("- 代币地址:",n);const a=await this.blockchainService.readContract(this.blockchainService.getVaultContractAddress(),d,"getUserBalance",[e,r,n]);return console.log("查询结果:",a.toString()),a}async getUserPoints(e,t){await this.blockchainService.ensureWalletConnected();if(!this.blockchainService.getPublicClient())throw new Error("公共客户端未初始化");const n=this.stringToBytes32(t);console.log("查询用户积分:"),console.log("- 用户地址:",e),console.log("- 商户ID:",t);const r=await this.blockchainService.readContract(this.blockchainService.getVaultContractAddress(),d,"getUserPoints",[e,n]);return console.log("查询结果:",r.toString()),r}async getMyVouchers(){await this.blockchainService.ensureWalletConnected();const e=this.blockchainService.getPublicClient(),t=this.blockchainService.getAccount();if(!e||!t)throw new Error("钱包未连接或初始化失败");console.log("查询我的代金券...");const n=await this.blockchainService.readContract(this.blockchainService.getVaultContractAddress(),d,"getMyVouchers",[]),r={ids:n[0],merchantIds:n[1],tokens:n[2],amounts:n[3],used:n[4],expireAts:n[5]};return console.log("查询到代金券数量:",r.ids.length),r}async getVoucher(e){await this.blockchainService.ensureWalletConnected();if(!this.blockchainService.getPublicClient())throw new Error("公共客户端未初始化");console.log("查询代金券详情:"),console.log("- 代金券ID:",e.toString());const t=await this.blockchainService.readContract(this.blockchainService.getVaultContractAddress(),d,"getVoucher",[e]),n={merchantId:t[0],token:t[1],amount:t[2],used:t[3],expireAt:t[4]};return console.log("代金券详情:",n),n}async getFeeReceiver(){await this.blockchainService.ensureWalletConnected();if(!this.blockchainService.getPublicClient())throw new Error("公共客户端未初始化");console.log("查询手续费接收地址...");const e=await this.blockchainService.readContract(this.blockchainService.getVaultContractAddress(),d,"feeReceiver",[]);return console.log("手续费接收地址:",e),e}async getFeeRuleProvider(){await this.blockchainService.ensureWalletConnected();if(!this.blockchainService.getPublicClient())throw new Error("公共客户端未初始化");console.log("查询手续费规则提供者地址...");const e=await this.blockchainService.readContract(this.blockchainService.getVaultContractAddress(),d,"feeRuleProvider",[]);return console.log("手续费规则提供者地址:",e),e}async getTrustedForwarder(){await this.blockchainService.ensureWalletConnected();if(!this.blockchainService.getPublicClient())throw new Error("公共客户端未初始化");console.log("查询可信转发器地址...");const e=await this.blockchainService.readContract(this.blockchainService.getVaultContractAddress(),d,"trustedForwarder",[]);return console.log("可信转发器地址:",e),e}async isTrustedForwarder(e){await this.blockchainService.ensureWalletConnected();if(!this.blockchainService.getPublicClient())throw new Error("公共客户端未初始化");console.log("检查是否为可信转发器:"),console.log("- 转发器地址:",e);const t=await this.blockchainService.readContract(this.blockchainService.getVaultContractAddress(),d,"isTrustedForwarder",[e]);return console.log("是否为可信转发器:",t),t}async getOwner(){await this.blockchainService.ensureWalletConnected();if(!this.blockchainService.getPublicClient())throw new Error("公共客户端未初始化");console.log("查询合约所有者地址...");const e=await this.blockchainService.readContract(this.blockchainService.getVaultContractAddress(),d,"owner",[]);return console.log("合约所有者地址:",e),e}async getPromoTier(e,t){await this.blockchainService.ensureWalletConnected();const n=this.stringToBytes32(e),r=await this.blockchainService.readContract(this.blockchainService.getVaultContractAddress(),d,"getPromoTier",[n,t]);return{minAmount:r[0],discountRate:r[1],voucherAmount:r[2],pointAmount:r[3],startTime:r[4],endTime:r[5],voucherExpirePeriod:r[6],enabled:r[7]}}async validateConsumeParams(e){if(!await this.blockchainService.readContract(this.blockchainService.getVaultContractAddress(),d,"tokenWhitelist",[e.token]))throw new Error("Token not whitelisted");if(e.amount<=0n)throw new Error("Amount must be greater than 0");if(await this.blockchainService.readContract(this.blockchainService.getVaultContractAddress(),d,"usedSeq",[e.seq]))throw new Error("Seq already used");const t=await this.getPromoTier(e.merchantId,Number(e.idx));if(!t.enabled)throw new Error("Promo tier not enabled");if(e.amount<t.minAmount)throw new Error("Not match minAmount");const n=Math.floor(Date.now()/1e3);if(n<Number(t.startTime)||n>Number(t.endTime))throw new Error("Not in promo time");if(await this.getUserBalance(e.userAddress,e.merchantId,e.token)<e.amount*t.discountRate/100n)throw new Error("Insufficient vault balance");if(0n!==e.voucherId){const t=await this.getVoucher(e.voucherId);if(t.used)throw new Error("Voucher already used");if(t.merchantId!==e.merchantId)throw new Error("Voucher merchant mismatch");if(t.token!==e.token)throw new Error("Voucher token mismatch");if(t.expireAt<=n)throw new Error("Voucher expired")}if(e.pointToUse>0n){if(await this.getUserPoints(e.userAddress,e.merchantId)<e.pointToUse)throw new Error("Insufficient points")}}}class A extends b{constructor(e){super(e)}async setPromoTier(e,t,n,r,a,s,o,i,c,l){await this.ensureWalletConnected();const u=this.stringToBytes32(e);return await this.writeContract(this.getVaultContractAddress(),d,"setPromoTier",[u,t,n,r,a,s,o,i,c,l])}stringToBytes32(e){if(e.startsWith("0x")&&66===e.length)return e;return"0x"+Buffer.from(e,"utf8").toString("hex").padEnd(64,"0")}generateMerchantId(e){if(!e||""===e.trim())throw new Error("商户名称不能为空");const t=i(e),n=c(t,{size:32});return console.log("生成的merchantId:",n),n}async setMerchantOperator(e,t){try{await this.ensureWalletConnected(),console.log("设置商户操作员..."),console.log("- 商户ID:",e),console.log("- 操作员地址:",t);const n=this.stringToBytes32(e),r=await this.writeContract(this.getVaultContractAddress(),d,"setMerchantOperator",[n,t]);return console.log("交易已发送，哈希:",r),{success:!0,message:"设置商户操作员交易已发送",data:{txHash:r}}}catch(e){return console.error("设置商户操作员失败:",e),{success:!1,message:`设置商户操作员失败: ${e.message}`}}}async checkMerchantOperator(e,t){try{await this.ensureWalletConnected(),console.log("检查商户操作员权限..."),console.log("- 商户ID:",e),console.log("- 操作员地址:",t);const n=this.stringToBytes32(e),r=await this.readContract(this.getVaultContractAddress(),d,"merchantOperator",[n]),a=r.toLowerCase()===t.toLowerCase();return console.log("操作员权限状态:",a),{success:!0,message:"获取商户操作员权限成功",data:{hasPermission:a,operatorAddress:r}}}catch(e){return console.error("获取商户操作员权限失败:",e),{success:!1,message:`获取商户操作员权限失败: ${e.message}`}}}async issueVoucher(e,t,n,r,a){try{await this.ensureWalletConnected(),console.log("发放代金券..."),console.log("- 商户ID:",e),console.log("- 用户地址:",t),console.log("- 代币地址:",n),console.log("- 代金券金额:",r.toString()),console.log("- 过期时间(秒):",a.toString());const s=this.stringToBytes32(e),o=await this.writeContract(this.getVaultContractAddress(),d,"issueVoucher",[t,s,n,r,a]);return console.log("交易已发送，哈希:",o),{success:!0,message:"发放代金券交易已发送",data:{txHash:o}}}catch(e){return console.error("发放代金券失败:",e),{success:!1,message:`发放代金券失败: ${e.message}`}}}async issuePoints(e,t,n){try{await this.ensureWalletConnected(),console.log("发放积分..."),console.log("- 商户ID:",e),console.log("- 用户地址:",t),console.log("- 积分数量:",n.toString());const r=this.stringToBytes32(e),a=await this.writeContract(this.getVaultContractAddress(),d,"issuePoints",[t,r,n]);return console.log("交易已发送，哈希:",a),{success:!0,message:"发放积分交易已发送",data:{txHash:a}}}catch(e){return console.error("发放积分失败:",e),{success:!1,message:`发放积分失败: ${e.message}`}}}}class I{constructor(e){this.blockchainService=e,this.signingService=new C(e),this.tokenOperations=new T(e),this.directPayment=new v(e),this.vaultOperations=new S(e),this.relayedPayment=new k(e)}async approveToken(e,t,n){return this.tokenOperations.approveToken(e,t,n)}async checkAllowance(e,t,n){return this.tokenOperations.checkAllowance(e,t,n)}encodePayCallData(e,t,n,r=0n){return this.directPayment.encodePayCallData(e,t,n,r)}async userPayDirect(e,t,n,r=BigInt(Math.floor(Date.now()/1e3))){return this.directPayment.pay(e,t,n,r)}async prepareRelayedPayment(e,t,n,r,a=3600){return this.relayedPayment.preparePayment(e,t,n,r,a)}async depositToVault(e,t,n){return this.vaultOperations.deposit(e,t,n)}async withdrawFromVault(e,t,n){return this.vaultOperations.withdraw(e,t,n)}async consumeFromVault(e,t,n,r=0n,a=0n,s=BigInt(Math.floor(Date.now()/1e3)),o,i,c){return this.vaultOperations.consumeDirect(e,t,n,r,a,s,o,i,c)}async getUserBalance(e,t,n){return this.vaultOperations.getUserBalance(e,t,n)}async getUserPoints(e,t){return this.vaultOperations.getUserPoints(e,t)}async getSpecificUserPoints(e,t){return this.vaultOperations.getUserPoints(e,t)}async prepareRelayedConsume(e,t,n,r=0n,a=0n,s=BigInt(Math.floor(Date.now()/1e3)),o,i,c=3600n,l){return this.vaultOperations.prepareRelayedConsume(e,t,n,r,a,s,o,i,c,l)}async prepareRelayedDeposit(e,t,n,r=3600n){return this.vaultOperations.prepareRelayedDeposit(e,t,n,r)}async prepareRelayedWithdraw(e,t,n,r=3600n){return this.vaultOperations.prepareRelayedWithdraw(e,t,n,r)}}class x{constructor(e={}){console.log("[Web3Delegate] 构造收到的config:",e),this.blockchainService=new b(e),console.log("[Web3Delegate] blockchainService.getPaymentContractAddress():",this.blockchainService.getPaymentContractAddress()),this.token=new T(this.blockchainService),this.directPayment=new v(this.blockchainService),this.relayedPayment=new k(this.blockchainService),this.vault=new S(this.blockchainService),this.merchantConfigManager=new A(e),this.transactionService=new I(this.blockchainService)}async connectWallet(){return this.blockchainService.connectWallet()}isConnected(){return this.blockchainService.isConnected()}getConnectedAddress(){return this.blockchainService.getConnectedAddress()}getChainId(){return this.blockchainService.getChainId()}async approveToken(e,t,n){return this.token.approveToken(e,t,n)}async checkAllowance(e,t,n){return this.token.checkAllowance(e,t,n)}async ensureTokenAllowance(e,t,n){return this.token.ensureTokenAllowance(e,t,n)}async userPayDirect(e,t,n,r){return this.directPayment.pay(e,t,n,r)}async prepareRelayedPayment(e,t,n,r,a=3600){return this.relayedPayment.preparePayment(e,t,n,r,a)}async depositToVault(e,t,n){return this.vault.deposit(e,t,n)}async withdrawFromVault(e,t,n){return this.vault.withdraw(e,t,n)}async getUserBalance(e,t,n){return this.vault.getUserBalance(e,t,n)}async consumeFromVault(e,t,n,r=0n,a=0n,s,o,i){if(!i)throw new Error("recipient is required");return this.vault.consumeDirect(e,t,n,r,a,o??BigInt(Date.now()),s,i)}async prepareRelayedConsume(e,t,n,r=0n,a=0n,s,o,i,c=3600n){if(!i)throw new Error("recipient is required");return this.vault.prepareRelayedConsume(e,t,n,r,a,o??BigInt(Date.now()),s,i,c)}async prepareRelayedDeposit(e,t,n,r=3600n){return this.vault.prepareRelayedDeposit(e,t,n,r)}async prepareRelayedWithdraw(e,t,n,r=3600n){return this.vault.prepareRelayedWithdraw(e,t,n,r)}}var P;!function(e){e.Payment="payment",e.Consume="consume",e.Deposit="deposit",e.Withdraw="withdraw"}(P||(P={}));class M extends b{constructor(e){super(e),this.paymentContractAddress=e.paymentContractAddress||this.getPaymentContractAddress(),this.consumeContractAddress=e.vaultContractAddress||this.getVaultContractAddress(),this.forwarderAddress=e.forwarderAddress||this.getForwarderAddress()||""}async validatePaymentRequest(e){try{await this.ensureWalletConnected();const{token:t,to:n,amount:r,gasFee:a,seq:s,from:o}=e;if(console.log("验证支付请求..."),console.log("- 代币:",t),console.log("- 接收方:",n),console.log("- 金额:",r.toString()),console.log("- Gas费:",a.toString()),console.log("- 序列号:",s.toString()),console.log("- 发送方:",o),r<=0n)return console.error("金额必须大于0"),{success:!1,error:"金额必须大于0"};try{if(await this.readContract(this.getPaymentContractAddress(),u,"usedSeq",[s]))return console.error("序列号已被使用"),{success:!1,error:"序列号已被使用"}}catch(e){return console.error("检查序列号失败:",e),{success:!1,error:`检查序列号失败: ${e.message}`}}try{if(!await this.readContract(this.getPaymentContractAddress(),u,"tokenWhitelist",[t]))return console.error("代币不在白名单中"),{success:!1,error:"代币不在白名单中"}}catch(e){return console.error("检查代币白名单失败:",e),{success:!1,error:`检查代币白名单失败: ${e.message}`}}try{const e=await this.readContract(this.getPaymentContractAddress(),u,"MAX_AMOUNT",[]);if(r>e)return console.error("金额超过最大限制"),{success:!1,error:`金额超过最大限制: ${e}`}}catch(e){return console.error("检查最大金额限制失败:",e),{success:!1,error:`检查最大金额限制失败: ${e.message}`}}try{if("0x0000000000000000000000000000000000000000"===await this.readContract(this.getPaymentContractAddress(),u,"feeAddress",[]))return console.error("手续费地址未设置"),{success:!1,error:"手续费地址未设置"}}catch(e){return console.error("检查手续费地址失败:",e),{success:!1,error:`检查手续费地址失败: ${e.message}`}}let i,c;try{if(i=await this.readContract(this.getPaymentContractAddress(),u,"minUnitPerToken",[t]),i<=0n)return console.error("代币最小单位未设置"),{success:!1,error:"代币最小单位未设置"};if(r<i)return console.error("金额低于最小单位"),{success:!1,error:`金额低于最小单位: ${i}`};if(r%i!==0n)return console.error("金额必须是最小单位的整数倍"),{success:!1,error:`金额必须是最小单位的整数倍: ${i}`}}catch(e){return console.error("检查最小单位失败:",e),{success:!1,error:`检查最小单位失败: ${e.message}`}}try{const e=await this.readContract(this.getPaymentContractAddress(),u,"feePpmPerTo",[n]);if(c=e>0n?e:await this.readContract(this.getPaymentContractAddress(),u,"feePpm",[]),c>=1000000n)return console.error("费率无效"),{success:!1,error:"费率无效"}}catch(e){return console.error("获取手续费率失败:",e),{success:!1,error:`获取手续费率失败: ${e.message}`}}const l=r*c/1000000n;if(l>=r)return console.error("手续费过高"),{success:!1,error:"手续费过高"};const d=r-l;return d<=0n?(console.error("接收方到账金额过低"),{success:!1,error:"接收方到账金额过低"}):(console.log("验证通过"),console.log("- 手续费率:",c.toString(),"ppm"),console.log("- 手续费:",l.toString()),console.log("- 实际到账:",d.toString()),{success:!0,fee:l,toAmount:d})}catch(e){return console.error("验证支付请求失败:",e),{success:!1,error:`验证支付请求失败: ${e.message}`}}}async validateConsumeRequest(e){try{await this.ensureWalletConnected();const{token:t,merchantId:n,amount:r,seq:a,from:s,voucherId:o=0n,pointToUse:i=0n}=e;let c,l;console.log("验证消费请求..."),console.log("- 商家ID:",n),console.log("- 代币:",t),console.log("- 金额:",r.toString()),console.log("- 序列号:",a.toString()),console.log("- 发送方:",s),o>0n&&console.log("- 代金券ID:",o.toString()),i>0n&&console.log("- 使用积分:",i.toString());try{if(c=await this.readContract(this.getVaultContractAddress(),d,"merchantRecipients",[n]),"0x0000000000000000000000000000000000000000"===c)return console.error("商家未设置"),{success:!1,error:"商家未设置"}}catch(e){return console.error("检查商家设置失败:",e),{success:!1,error:`检查商家设置失败: ${e.message}`}}try{if(!await this.readContract(this.getVaultContractAddress(),d,"tokenWhitelist",[t]))return console.error("代币不在白名单中"),{success:!1,error:"代币不在白名单中"}}catch(e){return console.error("检查代币白名单失败:",e),{success:!1,error:`检查代币白名单失败: ${e.message}`}}if(r<=0n)return console.error("金额必须大于0"),{success:!1,error:"金额必须大于0"};try{if(await this.readContract(this.getVaultContractAddress(),d,"usedSeq",[a]))return console.error("序列号已被使用"),{success:!1,error:"序列号已被使用"}}catch(e){return console.error("检查序列号失败:",e),{success:!1,error:`检查序列号失败: ${e.message}`}}try{l=await this.readContract(this.getVaultContractAddress(),d,"merchantConfigs",[n])}catch(e){return console.error("获取商家配置失败:",e),{success:!1,error:`获取商家配置失败: ${e.message}`}}let u=r,p=r,y=0n,h=0n;l.discountEnabled&&r>=l.discountBase&&(u=r*l.discountRate/100n,p=u,console.log("应用折扣:",l.discountRate.toString(),"%"),console.log("折扣后金额:",u.toString()));let m=0n;if(0n!==o)try{const e=await this.readContract(this.getVaultContractAddress(),d,"vouchers",[o]);if(e.used)return console.error("代金券已使用"),{success:!1,error:"代金券已使用"};if(e.merchantId!==n)return console.error("代金券不属于该商家"),{success:!1,error:"代金券不属于该商家"};const t=BigInt(Math.floor(Date.now()/1e3));if(e.expireAt<=t)return console.error("代金券已过期"),{success:!1,error:"代金券已过期"};if(!(await this.readContract(this.getVaultContractAddress(),d,"userVouchers",[s])).includes(o))return console.error("不是代金券所有者"),{success:!1,error:"不是代金券所有者"};m=e.amount,u=u>m?u-m:0n,console.log("✅ 验证通过：代金券有效"),console.log("- 代金券抵扣金额:",m.toString()),console.log("- 抵扣后金额:",u.toString())}catch(e){return console.error("验证代金券失败:",e),{success:!1,error:`验证代金券失败: ${e.message}`}}let g=0n;if(i>0n)try{const e=await this.readContract(this.getVaultContractAddress(),d,"userPoints",[s,n]);g=i>e?e:i,g>u&&(g=u),u-=g,console.log("- 可用积分:",e.toString()),console.log("- 使用积分:",g.toString()),console.log("- 积分抵扣后金额:",u.toString())}catch(e){return console.error("验证积分失败:",e),{success:!1,error:`验证积分失败: ${e.message}`}}try{const e=await this.readContract(this.getVaultContractAddress(),d,"userBalances",[s,t]);if(e<u)return console.error("余额不足"),console.error("- 用户余额:",e.toString()),console.error("- 需要金额:",u.toString()),{success:!1,error:"余额不足"};console.log("- 用户余额:",e.toString()),console.log("- 需要金额:",u.toString())}catch(e){return console.error("检查用户余额失败:",e),{success:!1,error:`检查用户余额失败: ${e.message}`}}try{const e=10000n;if(e>=1000000n)return console.error("费率过高"),{success:!1,error:"费率过高"};const t=u*e/1000000n,n=u-t;return n<=0n&&t<=0n?(console.error("没有可转账的金额"),{success:!1,error:"没有可转账的金额"}):(l.cashbackPointEnabled&&r>=l.cashbackPointBase&&(h=l.cashbackPointAmount),l.cashbackVoucherEnabled&&r>=l.cashbackVoucherBase&&(y=l.cashbackVoucherAmount),console.log("验证通过"),console.log("- 原始金额:",r.toString()),console.log("- 折扣后金额:",p.toString()),console.log("- 代金券抵扣:",m.toString()),console.log("- 积分抵扣:",g.toString()),console.log("- 实际扣除金额:",u.toString()),console.log("- 手续费率:",e.toString(),"ppm"),console.log("- 手续费:",t.toString()),console.log("- 商家到账金额:",n.toString()),console.log("- 返积分:",h.toString()),console.log("- 返券金额:",y.toString()),{success:!0,fee:t,merchantAmount:n,rewardAmount:h,voucherReward:y,discountedAmount:p,pointsUsed:g,voucherUsed:m,spendAmount:u})}catch(e){return console.error("计算手续费和奖励失败:",e),{success:!1,error:`计算手续费和奖励失败: ${e.message}`}}}catch(e){return console.error("验证消费请求失败:",e),{success:!1,error:`验证消费请求失败: ${e.message}`}}}async validateDepositRequest(e){try{await this.ensureWalletConnected();const{token:t,amount:n,seq:r,from:a}=e;console.log("验证存款请求..."),console.log("- 代币:",t),console.log("- 金额:",n.toString()),console.log("- 序列号:",r.toString()),console.log("- 发送方:",a);try{if(!await this.readContract(this.getVaultContractAddress(),d,"tokenWhitelist",[t]))return console.error("代币不在白名单中"),{success:!1,error:"代币不在白名单中"}}catch(e){return console.error("检查代币白名单失败:",e),{success:!1,error:`检查代币白名单失败: ${e.message}`}}if(n<=0n)return console.error("金额必须大于0"),{success:!1,error:"金额必须大于0"};try{if(await this.readContract(t,m,"balanceOf",[a])<n)return console.error("代币余额不足"),{success:!1,error:"代币余额不足"};if(await this.readContract(t,m,"allowance",[a,this.getVaultContractAddress()])<n)return console.error("代币授权不足"),{success:!1,error:"代币授权不足"}}catch(e){return console.error("检查代币余额和授权失败:",e),{success:!1,error:`检查代币余额和授权失败: ${e.message}`}}return console.log("验证通过"),{success:!0}}catch(e){return console.error("验证存款请求失败:",e),{success:!1,error:`验证存款请求失败: ${e.message}`}}}async validateWithdrawRequest(e){try{await this.ensureWalletConnected();const{token:t,amount:n,seq:r,from:a}=e;console.log("验证提款请求..."),console.log("- 代币:",t),console.log("- 金额:",n.toString()),console.log("- 序列号:",r.toString()),console.log("- 发送方:",a);try{const e=await this.readContract(this.getVaultContractAddress(),d,"userBalances",[a,t]);if(e<n)return console.error("余额不足"),console.error("- 用户余额:",e.toString()),console.error("- 提款金额:",n.toString()),{success:!1,error:"余额不足"};console.log("- 用户余额:",e.toString()),console.log("- 提款金额:",n.toString())}catch(e){return console.error("检查用户余额失败:",e),{success:!1,error:`检查用户余额失败: ${e.message}`}}return console.log("验证通过"),{success:!0}}catch(e){return console.error("验证提款请求失败:",e),{success:!1,error:`验证提款请求失败: ${e.message}`}}}encodePayCallData(e,t,n,r){return s({abi:u,functionName:"pay",args:[e,t,n,r]})}encodeConsumeCallData(e,t,n,r,a,o){return s({abi:d,functionName:"consume",args:[e,t,n,r,a,o]})}encodeDepositCallData(e,t){return s({abi:d,functionName:"deposit",args:[e,t]})}encodeWithdrawCallData(e,t){return s({abi:d,functionName:"withdraw",args:[e,t]})}async getNonce(e,t){try{return await this.readContract(this.forwarderAddress,p,"nonces",[e],t)}catch(e){throw console.error("获取nonce失败:",e),new Error(`获取nonce失败: ${e.message}`)}}async validateSimpleRequest(e,t){try{let n;if(console.log(`解析并验证 ${e} 请求...`),console.log("- 调用数据:",t.data),e===P.Payment){const e=this.decodePaymentData(t.data);n=await this.validatePaymentRequest({token:e.token,to:e.to,amount:e.amount,gasFee:e.gasFee||0n,seq:e.seq,from:t.from})}else if(e===P.Consume){const e=this.decodeConsumeData(t.data);n=await this.validateConsumeRequest({token:e.token,merchantId:e.merchantId,amount:e.amount,seq:e.seq,from:t.from,voucherId:e.voucherId,pointToUse:e.pointToUse})}else if(e===P.Deposit){const e=this.decodeDepositData(t.data);n=await this.validateDepositRequest({token:e.token,amount:e.amount,seq:0n,from:t.from})}else{if(e!==P.Withdraw)throw new Error(`不支持的操作类型: ${e}`);{const e=this.decodeWithdrawData(t.data);n=await this.validateWithdrawRequest({token:e.token,amount:e.amount,seq:0n,from:t.from})}}return n}catch(e){return console.error("解析和验证请求失败:",e),{success:!1,error:`解析和验证请求失败: ${e.message}`}}}async sendSimpleRequest(e,t){try{await this.ensureWalletConnected();const n={from:t.from,to:t.to,value:BigInt(t.value||"0"),gas:BigInt(t.gas||"500000"),deadline:BigInt(t.deadline),data:t.data,signature:t.signature};console.log("发送转发请求..."),console.log("- 类型:",e),console.log("- 发送方:",t.from),console.log("- 目标合约:",t.to),console.log("- 截止时间:",t.deadline);const r=await this.writeContract(this.forwarderAddress,p,"execute",[n]);return console.log("交易已发送，哈希:",r),{success:!0,txHash:r}}catch(e){return console.error("发送请求失败:",e),{success:!1,error:`发送请求失败: ${e.message}`}}}decodePaymentData(e){try{const t=e.slice(0,10);if("0xa4b072d0"===t){console.log("检测到 pay 函数调用，解析参数...");try{const t=l({abi:u,data:e});if("pay"===t.functionName&&t.args&&Array.isArray(t.args)){const e=void 0!==t.args[0]?String(t.args[0]):"",n=void 0!==t.args[1]?String(t.args[1]):"",r=void 0!==t.args[2]?BigInt(Number(t.args[2])):0n;return{token:e,to:n,amount:r,seq:void 0!==t.args[3]?BigInt(Number(t.args[3])):0n}}}catch(e){console.log("使用viem解码失败，尝试手动解析:",e)}const t=e.slice(10),n="0x"+t.slice(0,64).slice(-40),r="0x"+t.slice(64,128).slice(-40),a=BigInt("0x"+t.slice(128,192));return{token:n,to:r,amount:a,seq:BigInt("0x"+t.slice(192,256))}}throw new Error(`未知的函数选择器: ${t}`)}catch(e){throw console.error("解析支付数据失败:",e),new Error(`解析支付数据失败: ${e.message}`)}}decodeConsumeData(e){try{const t=e.slice(0,10);if("0x5d495aea"===t){console.log("检测到 consume 函数调用，解析参数...");try{const t=l({abi:d,data:e});if("consume"===t.functionName&&t.args&&Array.isArray(t.args)){const e=void 0!==t.args[0]?String(t.args[0]):"",n=void 0!==t.args[1]?String(t.args[1]):"",r=void 0!==t.args[2]?BigInt(Number(t.args[2])):0n,a=void 0!==t.args[3]?BigInt(Number(t.args[3])):0n,s=void 0!==t.args[4]?BigInt(Number(t.args[4])):0n;return{merchantId:e,token:n,amount:r,voucherId:a,pointToUse:s,seq:void 0!==t.args[5]?BigInt(Number(t.args[5])):0n}}}catch(e){console.log("使用viem解码失败，尝试手动解析:",e)}const t=e.slice(10),n="0x"+t.slice(0,64).slice(-40),r="0x"+t.slice(64,128).slice(-40),a=BigInt("0x"+t.slice(128,192)),s=BigInt("0x"+t.slice(192,256)),o=BigInt("0x"+t.slice(256,320));return{merchantId:n,token:r,amount:a,voucherId:s,pointToUse:o,seq:BigInt("0x"+t.slice(320,384))}}throw new Error(`未知的函数选择器: ${t}`)}catch(e){throw console.error("解析消费数据失败:",e),new Error(`解析消费数据失败: ${e.message}`)}}decodeDepositData(e){try{const t=e.slice(0,10);if("0x47e7ef24"===t){console.log("检测到 deposit 函数调用，解析参数...");try{const t=l({abi:d,data:e});if("deposit"===t.functionName&&t.args&&Array.isArray(t.args)){const e=void 0!==t.args[0]?String(t.args[0]):"";return{token:e,amount:void 0!==t.args[1]?BigInt(Number(t.args[1])):0n}}}catch(e){console.log("使用viem解码失败，尝试手动解析:",e)}const t=e.slice(10),n="0x"+t.slice(0,64).slice(-40);return{token:n,amount:BigInt("0x"+t.slice(64,128))}}throw new Error(`未知的函数选择器: ${t}`)}catch(e){throw console.error("解析存款数据失败:",e),new Error(`解析存款数据失败: ${e.message}`)}}decodeWithdrawData(e){try{const t=e.slice(0,10);if("0x441a3e70"===t){console.log("检测到 withdraw 函数调用，解析参数...");try{const t=l({abi:d,data:e});if("withdraw"===t.functionName&&t.args&&Array.isArray(t.args)){const e=void 0!==t.args[0]?String(t.args[0]):"";return{token:e,amount:void 0!==t.args[1]?BigInt(Number(t.args[1])):0n}}}catch(e){console.log("使用viem解码失败，尝试手动解析:",e)}const t=e.slice(10),n="0x"+t.slice(0,64).slice(-40);return{token:n,amount:BigInt("0x"+t.slice(64,128))}}throw new Error(`未知的函数选择器: ${t}`)}catch(e){throw console.error("解析提款数据失败:",e),new Error(`解析提款数据失败: ${e.message}`)}}}export{b as BlockchainService,A as MerchantConfigManager,P as OperationType,M as RelayerService,C as SigningService,I as TransactionService,w as WalletService,x as Web3Delegate};
//# sourceMappingURL=index.esm.js.map
